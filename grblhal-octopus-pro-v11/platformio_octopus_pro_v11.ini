; ═══════════════════════════════════════════════════════════════════════════
; PlatformIO Configuration - BTT Octopus Pro v1.1 (STM32F446)
; Para usar con grblHAL
; ═══════════════════════════════════════════════════════════════════════════
;
; INSTRUCCIONES:
; 1. Copia este archivo al directorio grblHAL-STM32F4xx como "platformio.ini"
; 2. Ejecuta: pio run -e btt_octopus_pro_v11_f446
; 3. Flashea en modo DFU: pio run -e btt_octopus_pro_v11_f446 -t upload
;
; ═══════════════════════════════════════════════════════════════════════════

[platformio]
include_dir = Inc
src_dir = Src
default_envs = btt_octopus_pro_v11_f446

[common]
build_flags =
  -I .
  -I boards
  -I FatFs
  -I FatFs/STM
  -I Drivers/FATFS/Target
  -I Middlewares/ST/STM32_USB_Device_Library/Class/CDC/Inc
  -I Middlewares/ST/STM32_USB_Device_Library/Core/Inc
  -I USB_DEVICE/App
  -I USB_DEVICE/Target
  -D _USE_IOCTL=1
  -D _USE_WRITE=1
  -D _VOLUMES=1
  -Wl,-u,_printf_float
  -Wl,-u,_scanf_float
  -D OVERRIDE_MY_MACHINE

lib_deps =
  boards
  bluetooth
  grbl
  keypad
  laser
  motors
  trinamic
  odometer
  fans
  spindle
  embroidery
  Drivers/FATFS/App
  Drivers/FATFS/Target
  Middlewares/ST/STM32_USB_Device_Library/Core
  Middlewares/ST/STM32_USB_Device_Library/Class
  USB_DEVICE/App
  USB_DEVICE/Target
  FatFs
  sdcard

lib_extra_dirs =
  .
  boards
  FatFs
  Middlewares/ST/STM32_USB_Device_Library
  USB_DEVICE

[env]
platform = ststm32
platform_packages = framework-stm32cubef4 @ ~1.26.2
framework = stm32cube
lib_archive = no
lib_ldf_mode = off

; ═══════════════════════════════════════════════════════════════════════════
; BTT Octopus Pro v1.1 - STM32F446ZET6
; ═══════════════════════════════════════════════════════════════════════════
[env:btt_octopus_pro_v11_f446]
board = genericSTM32F446ZE
board_build.mcu = stm32f446zet6
board_build.ldscript = STM32F446ZETX_FLASH.ld

build_flags = ${common.build_flags}
  ; ─── Configuración de Placa ───
  -D BOARD_BTT_OCTOPUS_PRO=
  -D STM32F446xx
  -D HSE_VALUE=12000000
  
  ; ─── USB Serial ───
  -D USB_SERIAL_CDC=1
  
  ; ─── Tarjeta SD ───
  -D SDCARD_ENABLE=1
  
  ; ─── EEPROM (32Kbit I2C) ───
  -D EEPROM_ENABLE=32
  
  ; ─── Sonda habilitada ───
  -D PROBE_ENABLE=1
  
  ; ─── Drivers TMC2209 via UART ───
  -D TRINAMIC_ENABLE=2209
  -D TRINAMIC_UART_ENABLE=2
  -D TRINAMIC_DYNAMIC_CURRENT=1
  -D TMC_X_ENABLE=1
  -D TMC_Y_ENABLE=1
  -D TMC_Z_ENABLE=1
  
  ; ═══════════════════════════════════════════════════════════════════════════
  ; NEMA17 60Ncm High-Torque Motor Configuration
  ; StepperOnline 60Ncm, 2.1A rated, 1.7Ω, 200 steps/rev
  ; Lead screw: 8mm pitch
  ; Microstepping: 16 microsteps → 400 steps/mm = (200 * 16) / 8
  ; ═══════════════════════════════════════════════════════════════════════════
  
  ; ─── Steps per mm ($100-$102) ───
  ; Formula: (motor_steps * microsteps) / lead_pitch = (200 * 16) / 8 = 400
  -D DEFAULT_X_STEPS_PER_MM=400.0f
  -D DEFAULT_Y_STEPS_PER_MM=400.0f
  -D DEFAULT_Z_STEPS_PER_MM=400.0f
  
  ; ─── Max feed rate mm/min ($110-$112) ───
  ; Z slower for safety with triple lead screws
  -D DEFAULT_X_MAX_RATE=5000.0f
  -D DEFAULT_Y_MAX_RATE=5000.0f
  -D DEFAULT_Z_MAX_RATE=2000.0f
  
  ; ─── Acceleration mm/s² ($120-$122) ───
  ; High torque motors can handle aggressive accel
  -D DEFAULT_X_ACCELERATION=400.0f
  -D DEFAULT_Y_ACCELERATION=400.0f
  -D DEFAULT_Z_ACCELERATION=250.0f
  
  ; ─── Max travel mm ($130-$132) ───
  -D DEFAULT_X_MAX_TRAVEL=350.0f
  -D DEFAULT_Y_MAX_TRAVEL=500.0f
  -D DEFAULT_Z_MAX_TRAVEL=120.0f
  
  ; ─── Motor current mA ($140-$142) ───
  ; 2000mA = safe max for TMC2209 (motor rated 2.1A)
  -D DEFAULT_X_CURRENT=2000.0f
  -D DEFAULT_Y_CURRENT=2000.0f
  -D DEFAULT_Z_CURRENT=2000.0f
  
  ; ─── Hold current mA ($143-$145) ───
  ; 50% of run current for holding
  -D DEFAULT_X_HOLD_CURRENT=1000.0f
  -D DEFAULT_Y_HOLD_CURRENT=1000.0f
  -D DEFAULT_Z_HOLD_CURRENT=1000.0f
  
  ; ─── Límites suaves habilitados ───
  -D DEFAULT_SOFT_LIMIT_ENABLE=1
  
  ; ─── Límites duros ($21) - Endstops físicos ───
  ; 7 = X+Y+Z hard limits enabled (binary 111)
  -D DEFAULT_HARD_LIMITS_ENABLE=7
  
  ; ─── Homing habilitado ($22) ───
  ; 7 = X+Y+Z homing enabled
  -D DEFAULT_HOMING_ENABLE=7
  
  ; ─── Homing feed rates ───
  -D DEFAULT_HOMING_SEEK_RATE=1500.0f
  -D DEFAULT_HOMING_FEED_RATE=100.0f
  -D DEFAULT_HOMING_PULLOFF=3.0f
  
  ; ─── Husillo PWM ───
  -D SPINDLE0_ENABLE=11
  -D N_SPINDLE=1
  
  ; ─── E-Stop habilitado ───
  -D ESTOP_ENABLE=1

lib_deps = ${common.lib_deps}
  eeprom

lib_extra_dirs = ${common.lib_extra_dirs}

; Flashear via DFU (modo bootloader USB)
upload_protocol = dfu

; ═══════════════════════════════════════════════════════════════════════════
; BTT Octopus Pro v1.1 - STM32F446 - SIN Trinamic (modo standalone)
; Usar si los drivers TMC están en modo standalone (sin UART)
; ═══════════════════════════════════════════════════════════════════════════
[env:btt_octopus_pro_v11_f446_standalone]
board = genericSTM32F446ZE
board_build.mcu = stm32f446zet6
board_build.ldscript = STM32F446ZETX_FLASH.ld

build_flags = ${common.build_flags}
  -D BOARD_BTT_OCTOPUS_PRO=
  -D STM32F446xx
  -D HSE_VALUE=12000000
  -D USB_SERIAL_CDC=1
  -D SDCARD_ENABLE=1
  -D EEPROM_ENABLE=32
  -D PROBE_ENABLE=1
  ; SIN Trinamic - drivers en modo standalone (set current via VREF)
  -D TRINAMIC_ENABLE=0
  
  ; ─── Motor defaults (same as UART version) ───
  -D DEFAULT_X_STEPS_PER_MM=400.0f
  -D DEFAULT_Y_STEPS_PER_MM=400.0f
  -D DEFAULT_Z_STEPS_PER_MM=400.0f
  -D DEFAULT_X_MAX_RATE=5000.0f
  -D DEFAULT_Y_MAX_RATE=5000.0f
  -D DEFAULT_Z_MAX_RATE=2000.0f
  -D DEFAULT_X_ACCELERATION=400.0f
  -D DEFAULT_Y_ACCELERATION=400.0f
  -D DEFAULT_Z_ACCELERATION=250.0f
  -D DEFAULT_X_MAX_TRAVEL=350.0f
  -D DEFAULT_Y_MAX_TRAVEL=500.0f
  -D DEFAULT_Z_MAX_TRAVEL=120.0f
  
  -D DEFAULT_SOFT_LIMIT_ENABLE=1
  -D DEFAULT_HARD_LIMITS_ENABLE=7
  -D DEFAULT_HOMING_ENABLE=7
  -D DEFAULT_HOMING_SEEK_RATE=1500.0f
  -D DEFAULT_HOMING_FEED_RATE=100.0f
  -D DEFAULT_HOMING_PULLOFF=3.0f
  -D SPINDLE0_ENABLE=11
  -D N_SPINDLE=1
  -D ESTOP_ENABLE=1

lib_deps = ${common.lib_deps}
  eeprom

lib_extra_dirs = ${common.lib_extra_dirs}
upload_protocol = dfu

; ═══════════════════════════════════════════════════════════════════════════
; BTT Octopus Pro v1.1 - STM32F446 - Con TMC5160 (SPI)
; Para drivers de alta potencia TMC5160
; ═══════════════════════════════════════════════════════════════════════════
[env:btt_octopus_pro_v11_f446_tmc5160]
board = genericSTM32F446ZE
board_build.mcu = stm32f446zet6
board_build.ldscript = STM32F446ZETX_FLASH.ld

build_flags = ${common.build_flags}
  -D BOARD_BTT_OCTOPUS_PRO=
  -D STM32F446xx
  -D HSE_VALUE=12000000
  -D USB_SERIAL_CDC=1
  -D SDCARD_ENABLE=1
  -D EEPROM_ENABLE=32
  -D PROBE_ENABLE=1
  -D TRINAMIC_ENABLE=5160
  -D TRINAMIC_SPI_ENABLE=1
  -D DEFAULT_SOFT_LIMIT_ENABLE=1
  -D DEFAULT_HOMING_ENABLE=1
  -D SPINDLE0_ENABLE=11
  -D N_SPINDLE=1
  -D ESTOP_ENABLE=1

lib_deps = ${common.lib_deps}
  eeprom

lib_extra_dirs = ${common.lib_extra_dirs}
upload_protocol = dfu
